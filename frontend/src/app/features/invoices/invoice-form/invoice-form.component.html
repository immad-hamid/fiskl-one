<div class="invoice-form-container">
  <div class="page-header">
    <h1>{{ isEditMode ? "Edit Invoice" : "Create Invoice" }}</h1>
    <div class="header-actions">
      <button nz-button (click)="goBack()">
        <span nz-icon nzType="arrow-left"></span>
        Back
      </button>
    </div>
  </div>

  <nz-spin [nzSpinning]="loading">
    <form nz-form [formGroup]="invoiceForm">
      <!-- Invoice Details -->
      <nz-card nzTitle="Invoice Details" class="form-card">
        <div nz-row [nzGutter]="16">
          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Invoice Type</nz-form-label>
              <nz-form-control nzErrorTip="Please select invoice type">
                <nz-select
                  formControlName="invoiceType"
                  nzPlaceHolder="Select invoice type"
                >
                  <nz-option
                    nzValue="Sale Invoice"
                    nzLabel="Sale Invoice"
                  ></nz-option>
                  <nz-option
                    nzValue="Purchase Invoice"
                    nzLabel="Purchase Invoice"
                  ></nz-option>
                  <nz-option
                    nzValue="Credit Note"
                    nzLabel="Credit Note"
                  ></nz-option>
                  <nz-option
                    nzValue="Debit Note"
                    nzLabel="Debit Note"
                  ></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Invoice Date</nz-form-label>
              <nz-form-control nzErrorTip="Please select invoice date">
                <nz-date-picker
                  formControlName="invoiceDate"
                  nzPlaceHolder="Select date"
                  nzFormat="yyyy-MM-dd HH:mm:ss"
                  style="width: 100%"
                >
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label>Invoice Reference</nz-form-label>
              <nz-form-control>
                <input
                  nz-input
                  formControlName="invoiceRefNo"
                  placeholder="Enter reference number"
                />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Scenario ID</nz-form-label>
              <nz-form-control nzErrorTip="Please enter scenario ID">
                <input
                  nz-input
                  formControlName="scenarioId"
                  placeholder="e.g., SN000"
                />
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>
      </nz-card>

      <!-- Seller Information -->
      <nz-card nzTitle="Seller Information" class="form-card">
        <div nz-row [nzGutter]="16">
          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>NTN/CNIC</nz-form-label>
              <nz-form-control nzErrorTip="Please enter seller NTN/CNIC">
                <input
                  nz-input
                  formControlName="sellerNTNCNIC"
                  placeholder="Enter NTN/CNIC"
                />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Business Name</nz-form-label>
              <nz-form-control nzErrorTip="Please enter seller business name">
                <input
                  nz-input
                  formControlName="sellerBusinessName"
                  placeholder="Enter business name"
                />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Province</nz-form-label>
              <nz-form-control nzErrorTip="Please select seller province">
                <nz-select
                  formControlName="sellerProvince"
                  nzPlaceHolder="Select province"
                >
                  <nz-option nzValue="Punjab" nzLabel="Punjab"></nz-option>
                  <nz-option nzValue="Sindh" nzLabel="Sindh"></nz-option>
                  <nz-option
                    nzValue="KPK"
                    nzLabel="Khyber Pakhtunkhwa"
                  ></nz-option>
                  <nz-option
                    nzValue="Balochistan"
                    nzLabel="Balochistan"
                  ></nz-option>
                  <nz-option
                    nzValue="Islamabad"
                    nzLabel="Islamabad"
                  ></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzSpan="24">
            <nz-form-item>
              <nz-form-label nzRequired>Address</nz-form-label>
              <nz-form-control nzErrorTip="Please enter seller address">
                <textarea
                  nz-input
                  formControlName="sellerAddress"
                  placeholder="Enter complete address"
                >
                </textarea>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>
      </nz-card>

      <!-- Buyer Information -->
      <nz-card nzTitle="Buyer Information" class="form-card">
        <div nz-row [nzGutter]="16">
          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>NTN/CNIC</nz-form-label>
              <nz-form-control nzErrorTip="Please enter buyer NTN/CNIC">
                <input
                  nz-input
                  formControlName="buyerNTNCNIC"
                  placeholder="Enter NTN/CNIC"
                />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Business Name</nz-form-label>
              <nz-form-control nzErrorTip="Please enter buyer business name">
                <input
                  nz-input
                  formControlName="buyerBusinessName"
                  placeholder="Enter business name"
                />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Province</nz-form-label>
              <nz-form-control nzErrorTip="Please select buyer province">
                <nz-select
                  formControlName="buyerProvince"
                  nzPlaceHolder="Select province"
                >
                  <nz-option nzValue="Punjab" nzLabel="Punjab"></nz-option>
                  <nz-option nzValue="Sindh" nzLabel="Sindh"></nz-option>
                  <nz-option
                    nzValue="KPK"
                    nzLabel="Khyber Pakhtunkhwa"
                  ></nz-option>
                  <nz-option
                    nzValue="Balochistan"
                    nzLabel="Balochistan"
                  ></nz-option>
                  <nz-option
                    nzValue="Islamabad"
                    nzLabel="Islamabad"
                  ></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Registration Type</nz-form-label>
              <nz-form-control nzErrorTip="Please select registration type">
                <nz-select
                  formControlName="buyerRegistrationType"
                  nzPlaceHolder="Select type"
                >
                  <nz-option
                    nzValue="Registered"
                    nzLabel="Registered"
                  ></nz-option>
                  <nz-option
                    nzValue="Unregistered"
                    nzLabel="Unregistered"
                  ></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzSpan="24">
            <nz-form-item>
              <nz-form-label nzRequired>Address</nz-form-label>
              <nz-form-control nzErrorTip="Please enter buyer address">
                <textarea
                  nz-input
                  formControlName="buyerAddress"
                  placeholder="Enter complete address"
                >
                </textarea>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>
      </nz-card>

      <!-- Invoice Items -->
      <nz-card class="form-card">
        <div class="card-header" nz-card-head>
          <div class="card-title">Invoice Items</div>
          <div class="card-extra">
            <button
              nz-button
              nzType="dashed"
              (click)="addItem()"
              nz-tooltip
              nzTooltipTitle="Add new item"
            >
              <span nz-icon nzType="plus"></span>
              Add Item
            </button>
          </div>
        </div>

        <div formArrayName="items">
          <nz-table
            [nzData]="itemsFormArray.controls"
            [nzShowPagination]="false"
            nzSize="small"
          >
            <thead>
              <tr>
                <th nzWidth="120px">HS Code *</th>
                <th>Description *</th>
                <th nzWidth="80px">Rate *</th>
                <th nzWidth="80px">UoM *</th>
                <th nzWidth="80px">Qty *</th>
                <th nzWidth="120px">Unit Price *</th>
                <th nzWidth="120px">Sales Tax *</th>
                <th nzWidth="100px">Discount</th>
                <th nzWidth="120px">Total Value</th>
                <th nzWidth="60px">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let item of itemsFormArray.controls; let i = index"
                [formGroupName]="i"
              >
                <td>
                  <input
                    nz-input
                    formControlName="hsCode"
                    placeholder="0000.0000"
                    (blur)="calculateItemTotal(i)"
                  />
                </td>
                <td>
                  <input
                    nz-input
                    formControlName="productDescription"
                    placeholder="Product description"
                  />
                </td>
                <td>
                  <input nz-input formControlName="rate" placeholder="17%" />
                </td>
                <td>
                  <nz-form-control nzErrorTip="Please select unit of measure">
                    <nz-select
                      formControlName="uoM"
                      nzPlaceHolder="Select UoM"
                      style="width: 100%"
                    >
                      <nz-option nzValue="PCS" nzLabel="PCS"></nz-option>
                      <nz-option nzValue="KG" nzLabel="KG"></nz-option>
                    </nz-select>
                  </nz-form-control>
                </td>

                <td>
                  <input
                    nz-input
                    formControlName="quantity"
                    placeholder="0"
                    (ngModelChange)="calculateItemTotal(i)"
                    style="width: 100%"
                  />
                </td>
                <td>
                  <input
                    nz-input
                    formControlName="valueSalesExcludingST"
                    placeholder="0.00"
                    (ngModelChange)="calculateItemTotal(i)"
                    style="width: 100%"
                  />
                </td>
                <td>
                  <input
                    nz-input
                    formControlName="salesTaxApplicable"
                    placeholder="0.00"
                    (ngModelChange)="calculateItemTotal(i)"
                    style="width: 100%"
                  />
                </td>
                <td>
                  <input
                    nz-input
                    formControlName="discount"
                    placeholder="0.00"
                    (ngModelChange)="calculateItemTotal(i)"
                    style="width: 100%"
                  />
                </td>
                <td>
                  <div class="total-display">
                    {{ getItemTotal(i) | number : "1.2-2" }}
                  </div>
                </td>
                <td>
                  <button
                    nz-button
                    nzType="text"
                    nzDanger
                    nzSize="small"
                    nz-popconfirm
                    nzPopconfirmTitle="Remove this item?"
                    (nzOnConfirm)="removeItem(i)"
                    [disabled]="itemsFormArray.length === 1"
                  >
                    <span nz-icon nzType="delete"></span>
                  </button>
                </td>
              </tr>
            </tbody>
          </nz-table>

          <div class="items-summary">
            <div class="summary-row">
              <strong>Total Items: {{ itemsFormArray.length }}</strong>
            </div>
            <div class="summary-row">
              <strong
                >Grand Total: PKR
                {{ getGrandTotal() | number : "1.2-2" }}</strong
              >
            </div>
          </div>
        </div>
      </nz-card>

      <!-- Form Actions -->
      <div class="form-actions">
        <button nz-button nzSize="large" (click)="goBack()">Cancel</button>
        <button
          nz-button
          nzType="default"
          nzSize="large"
          (click)="saveDraft()"
          [nzLoading]="saving"
        >
          Save as Draft
        </button>
        <button
          (click)="onSubmit()"
          nz-button
          nzType="primary"
          nzSize="large"
          [nzLoading]="saving"
          [disabled]="!invoiceForm.valid"
        >
          {{ isEditMode ? "Update Invoice" : "Create Invoice" }}
        </button>
      </div>
    </form>
  </nz-spin>
</div>
