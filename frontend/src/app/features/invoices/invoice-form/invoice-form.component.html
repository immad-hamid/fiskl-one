<div class="invoice-form-container">
  <div class="page-header">
    <h1>{{ isEditMode ? "Edit Invoice" : "Create Invoice" }}</h1>
    <div class="header-actions">
      <button nz-button (click)="goBack()">
        <span nz-icon nzType="arrow-left"></span>
        Back
      </button>
    </div>
  </div>

  <nz-spin [nzSpinning]="loading">
    <form nz-form [formGroup]="invoiceForm">
      <!-- Invoice Details -->
      <nz-card nzTitle="Invoice Details" class="form-card">
        <div nz-row [nzGutter]="16">
          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Invoice Type</nz-form-label>
              <nz-form-control nzErrorTip="Please select invoice type">
                <ng-select
                  class="field__input"
                  [items]="[
                    'Sale Invoice',
                    'Purchase Invoice',
                    'Credit Note',
                    'Debit Note'
                  ]"
                  formControlName="invoiceType"
                  placeholder="Select invoice type"
                >
                </ng-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Invoice Date</nz-form-label>
              <nz-form-control nzErrorTip="Please select invoice date">
                <nz-date-picker
                  formControlName="invoiceDate"
                  nzPlaceHolder="Select date"
                  nzFormat="yyyy-MM-dd HH:mm:ss"
                  style="width: 100%"
                >
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label>Invoice Reference</nz-form-label>
              <nz-form-control>
                <input
                  nz-input
                  formControlName="invoiceRefNo"
                  placeholder="Enter reference number"
                />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="16">
            <nz-form-item>
              <nz-form-label nzRequired>Scenario ID</nz-form-label>
              <nz-form-control nzErrorTip="Please enter scenario ID">
                <ng-select
                  class="field__input"
                  [items]="scenarioTypes"
                  bindLabel="desc"
                  bindValue="id"
                  formControlName="scenarioId"
                  placeholder="Goods at standard rate to registered buyers"
                >
                </ng-select>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>
      </nz-card>

      <!-- Seller Information -->
      <nz-card nzTitle="Seller Information" class="form-card">
        <div nz-row [nzGutter]="16">
          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>NTN/CNIC</nz-form-label>
              <nz-form-control nzErrorTip="Please enter seller NTN/CNIC">
                <input
                  nz-input
                  formControlName="sellerNTNCNIC"
                  placeholder="Enter NTN/CNIC"
                />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Business Name</nz-form-label>
              <nz-form-control nzErrorTip="Please enter seller business name">
                <input
                  nz-input
                  formControlName="sellerBusinessName"
                  placeholder="Enter business name"
                />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Province</nz-form-label>
              <nz-form-control nzErrorTip="Please select seller province">
                <ng-select
                  class="field__input"
                  [items]="provinceOptions"
                  bindLabel="description"
                  bindValue="description"
                  formControlName="sellerProvince"
                  placeholder="Select province"
                >
                </ng-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzSpan="24">
            <nz-form-item>
              <nz-form-label nzRequired>Address</nz-form-label>
              <nz-form-control nzErrorTip="Please enter seller address">
                <textarea
                  nz-input
                  formControlName="sellerAddress"
                  placeholder="Enter complete address"
                ></textarea>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>
      </nz-card>

      <!-- Buyer Information -->
      <nz-card nzTitle="Buyer Information" class="form-card">
        <div nz-row [nzGutter]="16">
          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>NTN/CNIC</nz-form-label>
              <nz-form-control nzErrorTip="Please enter buyer NTN/CNIC">
                <input
                  nz-input
                  formControlName="buyerNTNCNIC"
                  placeholder="Enter NTN/CNIC"
                />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Business Name</nz-form-label>
              <nz-form-control nzErrorTip="Please enter buyer business name">
                <input
                  nz-input
                  formControlName="buyerBusinessName"
                  placeholder="Enter business name"
                />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Province</nz-form-label>
              <nz-form-control nzErrorTip="Please select buyer province">
                <ng-select
                  class="field__input"
                  [items]="provinceOptions"
                  bindLabel="description"
                  bindValue="description"
                  formControlName="buyerProvince"
                  placeholder="Select province"
                >
                </ng-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12" nzMd="8">
            <nz-form-item>
              <nz-form-label nzRequired>Registration Type</nz-form-label>
              <nz-form-control nzErrorTip="Please select registration type">
                <ng-select
                  class="field__input"
                  [items]="['Registered', 'Unregistered']"
                  formControlName="buyerRegistrationType"
                  placeholder="Select type"
                >
                </ng-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzSpan="24">
            <nz-form-item>
              <nz-form-label nzRequired>Address</nz-form-label>
              <nz-form-control nzErrorTip="Please enter buyer address">
                <textarea
                  nz-input
                  formControlName="buyerAddress"
                  placeholder="Enter complete address"
                ></textarea>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>
      </nz-card>

      <!-- Items Header -->
      <div class="card-header" nz-card-head>
        <div class="card-title">Invoice Items</div>
        <div class="card-extra"></div>
      </div>

      <!-- Items -->
      @for (item of itemsFormArray.controls; track $index) {
      <div formArrayName="items" class="items-grid">
        <div class="item-card" [formGroupName]="$index">
          <div class="item-card__header">
            <div class="item-card__title">Item #{{ $index + 1 }}</div>
            <button
              nz-button
              nzType="text"
              nzDanger
              nzSize="small"
              nz-popconfirm
              nzPopconfirmTitle="Remove this item?"
              (nzOnConfirm)="removeItem($index)"
              [disabled]="itemsFormArray.length === 1"
              aria-label="Remove item"
            >
              <span nz-icon nzType="delete"></span>
            </button>
          </div>

          <div class="item-card__fields">
            <label class="field">
              <span class="field__label">HS Code *</span>
              <ng-select
                class="field__input"
                [items]="hsCodeOptions"
                bindLabel="hsCode"
                bindValue="hsCode"
                formControlName="hsCode"
                placeholder="Search HS code"
                [searchable]="true"
              >
              </ng-select>
            </label>

            <label class="field field--wide">
              <span class="field__label">Description *</span>
              <input
                nz-input
                class="field__input"
                formControlName="productDescription"
                placeholder="Product description"
              />
            </label>

            <label class="field field--wide">
              <span class="field__label">Sale Type</span>
              <ng-select
                class="field__input"
                [items]="saleTypeOptions"
                bindLabel="description"
                bindValue="description"
                formControlName="saleType"
                placeholder="Select sale type"
                [clearable]="true"
              >
              </ng-select>
            </label>

            <label class="field">
              <span class="field__label">Rate *</span>
              <input
                nz-input
                class="field__input"
                formControlName="rate"
                placeholder="18% ..."
              />
            </label>

            <label class="field">
              <span class="field__label">UoM *</span>
              <ng-select
                class="field__input"
                [items]="uomOptions"
                bindLabel="name"
                bindValue="name"
                formControlName="uoM"
                placeholder="Select UoM"
              >
              </ng-select>
            </label>

            <label class="field">
              <span class="field__label">Quantity *</span>
              <input
                nz-input
                class="field__input"
                formControlName="quantity"
                placeholder="0"
                (change)="calculateItemTotal($index)"
              />
            </label>

            <label class="field">
              <span class="field__label">Unit Price *</span>
              <input
                nz-input
                class="field__input"
                formControlName="valueSalesExcludingST"
                placeholder="0.00"
                (change)="calculateItemTotal($index)"
              />
            </label>

            <label class="field">
              <span class="field__label">Fixed Notified/Retail</span>
              <input
                nz-input
                class="field__input"
                formControlName="fixedNotifiedValueOrRetailPrice"
                placeholder="0.00"
                (change)="calculateItemTotal($index)"
              />
            </label>

            <label class="field">
              <span class="field__label">Sales Tax *</span>
              <input
                nz-input
                class="field__input"
                formControlName="salesTaxApplicable"
                placeholder="0.00"
                (change)="calculateItemTotal($index)"
              />
            </label>

            <label class="field">
              <span class="field__label">Withheld @ Source</span>
              <input
                nz-input
                class="field__input"
                formControlName="salesTaxWithheldAtSource"
                placeholder="0.00"
                (change)="calculateItemTotal($index)"
              />
            </label>

            <label class="field">
              <span class="field__label">Extra Tax</span>
              <input
                nz-input
                class="field__input"
                formControlName="extraTax"
                placeholder="e.g., 0 or description"
              />
            </label>

            <label class="field">
              <span class="field__label">Further Tax</span>
              <input
                nz-input
                class="field__input"
                formControlName="furtherTax"
                placeholder="0.00"
                (change)="calculateItemTotal($index)"
              />
            </label>

            <label class="field field--wide">
              <span class="field__label">SRO Schedule No</span>
              <input
                nz-input
                class="field__input"
                formControlName="sroScheduleNo"
                placeholder="Schedule number"
              />
            </label>

            <label class="field">
              <span class="field__label">FED Payable</span>
              <input
                nz-input
                class="field__input"
                formControlName="fedPayable"
                placeholder="0.00"
                (change)="calculateItemTotal($index)"
              />
            </label>

            <label class="field">
              <span class="field__label">Discount</span>
              <input
                nz-input
                class="field__input"
                formControlName="discount"
                placeholder="0.00"
                (change)="calculateItemTotal($index)"
              />
            </label>

            <label class="field">
              <span class="field__label">SRO Item Serial No</span>
              <input
                nz-input
                class="field__input"
                formControlName="sroItemSerialNo"
                placeholder="Serial no"
              />
            </label>

            <div class="field field--total">
              <span class="field__label">Total Value</span>
              <div class="total-display">
                {{ getItemTotal($index) | number : "1.2-2" }}
              </div>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- Summary -->
      <div class="items-summary">
        <div class="summary-row">
          <strong>Total Items: {{ itemsFormArray.length }}</strong>
        </div>
        <div class="summary-row">
          <strong
            >Grand Total: PKR {{ getGrandTotal() | number : "1.2-2" }}</strong
          >
        </div>
      </div>

      <!-- Actions -->
      <div class="form-actions">
        <button nz-button nzSize="large" (click)="goBack()">Cancel</button>
        <button
          nz-button
          nzType="default"
          nzSize="large"
          (click)="saveDraft()"
          [nzLoading]="saving"
        >
          Save as Draft
        </button>
        <button
          (click)="onSubmit()"
          nz-button
          nzType="primary"
          nzSize="large"
          [nzLoading]="saving"
          [disabled]="!invoiceForm.valid"
        >
          {{ isEditMode ? "Update Invoice" : "Create Invoice" }}
        </button>
      </div>
    </form>
  </nz-spin>
</div>
